# Verbesserte CI-Schritte für robustes pnpm-Abhängigkeitsmanagement
# Diese Schritte können in die bestehende .github/workflows/ci.yml integriert werden

# Ersetze die bestehenden pnpm-Schritte (Zeilen 57-79) mit:

- name: Setup pnpm
  uses: pnpm/action-setup@a7487c7e89a18df4991f7f222e4898a00d66ddda # v4.1.0
  with:
    version: latest

- name: Get pnpm store directory
  id: pnpm-cache
  shell: bash
  run: |
    echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

- name: Setup pnpm cache for scaffold
  uses: actions/cache@v4
  with:
    path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
    key: ${{ matrix.os.name }}-pnpm-scaffold-${{ hashFiles('scaffold/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ matrix.os.name }}-pnpm-scaffold-

- name: Setup pnpm cache for nextjs-template
  uses: actions/cache@v4
  with:
    path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
    key: ${{ matrix.os.name }}-pnpm-nextjs-${{ hashFiles('nextjs-template/pnpm-lock.yaml') }}
    restore-keys: |
      ${{ matrix.os.name }}-pnpm-nextjs-

- name: Clone nextjs-template
  run: git clone --depth 1 https://github.com/dyad-sh/nextjs-template.git nextjs-template

# Robuste Installation mit Retry-Mechanismus und besserer Fehlerbehandlung
- name: Install scaffold dependencies (with retry)
  shell: bash
  run: |
    cd scaffold
    echo "Installing scaffold dependencies..."

    # Erste Attemptauflösung
    if ! pnpm install --frozen-lockfile; then
      echo "Frozen lockfile install failed, trying with lockfile update..."
      pnpm install --no-frozen-lockfile
    fi

    # Verify installation
    if ! pnpm list --depth=0; then
      echo "ERROR: scaffold dependency verification failed"
      exit 1
    fi

- name: Install nextjs-template dependencies (with retry)
  shell: bash
  run: |
    cd nextjs-template
    echo "Installing nextjs-template dependencies..."

    # Erste Attemptauflösung
    if ! pnpm install --frozen-lockfile; then
      echo "Frozen lockfile install failed, trying with lockfile update..."
      pnpm install --no-frozen-lockfile
    fi

    # Verify installation
    if ! pnpm list --depth=0; then
      echo "ERROR: nextjs-template dependency verification failed"
      exit 1  
    fi

# Debug-Informationen für Fehlerbehebung
- name: Debug dependency info
  if: failure()
  run: |
    echo "=== Debug Information ==="
    echo "Node version: $(node --version)"
    echo "npm version: $(npm --version)" 
    echo "pnpm version: $(pnpm --version)"
    echo ""
    echo "=== pnpm store info ==="
    pnpm store path
    pnpm store status
    echo ""
    echo "=== scaffold lockfile hash ==="
    if [ -f scaffold/pnpm-lock.yaml ]; then
      shasum scaffold/pnpm-lock.yaml
    else
      echo "scaffold/pnpm-lock.yaml not found"
    fi
    echo ""
    echo "=== nextjs-template lockfile hash ==="
    if [ -f nextjs-template/pnpm-lock.yaml ]; then
      shasum nextjs-template/pnpm-lock.yaml  
    else
      echo "nextjs-template/pnpm-lock.yaml not found"
    fi
